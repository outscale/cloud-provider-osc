name: e2e_test

on:
  push:
    branches:
      - kubernetes-*
  pull_request:
    branches:
      - main
      - kubernetes-*
    paths:
      - "**.go"
      - "Dockerfile"
      - "Makefile"
      - "go.*"
      - "deploy/k8s-osc-ccm/**.yaml"
      - ".github/workflows/e2e_test.yml"
      - ".github/local_action/start_ccm_e2e/action.yml"
  workflow_dispatch:
    
permissions:
  contents: read
 
jobs:
  create_cluster:
    runs-on: [self-hosted, linux]
    steps:
    - name: ‚¨áÔ∏è Checkout
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
    - name: ‚¨áÔ∏è Install kubectl
      uses: azure/setup-kubectl@776406bce94f63e41d621b960d78ee25c8b76ede # v4
      with:
        version: v1.34.2
    - name: ‚¨áÔ∏è Install Helm
      uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 # v4
    - name: ‚¨áÔ∏è Install Python
      uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6
    - name: ‚¨áÔ∏è Install Go
      uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6
      with:
        go-version-file: 'go.mod'
    - name: üîê Set AK/SK name based on runner region
      run: .github/scripts/runneraksk.sh
    - name: üßπ Frieza
      uses: outscale/frieza-github-actions/frieza-clean@master
      with:
        access_key: ${{ secrets[env.OSC_ACCESS_KEY_NAME] }}
        secret_key: ${{ secrets[env.OSC_SECRET_KEY_NAME] }}
        region: ${{ env.OSC_REGION }}
    - name: üì¶ Build and push Docker image 
      run: |
        docker login ${{ vars.REGISTRY }} -u admin -p ${{ secrets.HARBOR_ADMIN_PASSWORD }}
        make buildx-image image-tag image-push
      env:
        REGISTRY_IMAGE: ${{ vars.REGISTRY }}/outscale/cloud-provider-osc
        VERSION: ${{ format('{0}.{1}', github.sha, github.run_attempt) }}
    ## Create VPC Cluster
    - name: üß™ Test on VPC cluster
      uses: ./.github/local_action/start_ccm_e2e
      with:
        osc_access_key: ${{ secrets[env.OSC_ACCESS_KEY_NAME] }}
        osc_secret_key: ${{ secrets[env.OSC_SECRET_KEY_NAME] }}
        osc_region: ${{ env.OSC_REGION }}
        oks_access_key: ${{ secrets.OKS_ACCESS_KEY }}
        oks_secret_key: ${{ secrets.OKS_SECRET_KEY }}
        oks_region: ${{ vars.OKS_REGION }}
        image_name: ${{ vars.OMI_NAME }}
        version: ${{ format('{0}.{1}', github.sha, github.run_attempt) }}
        registry: ${{ vars.REGISTRY }}
    ## Create Public Cloud Cluster
    # - name: üß™ Test on Public cluster
    #   uses: ./.github/local_action/start_ccm_e2e
    #   with:
    #     osc_access_key: ${{ secrets[env.OSC_ACCESS_KEY_NAME] }}
    #     osc_secret_key: ${{ secrets[env.OSC_SECRET_KEY_NAME] }}
    #     osc_region: ${{ env.OSC_REGION }}
    #     public_cloud: "true"
    #     image_id: ${{ secrets.OMI_ID }}
    #     version: ${{ format('{0}.{1}', github.sha, github.run_attempt) }}
    #     registry: ${{ vars.REGISTRY }}
